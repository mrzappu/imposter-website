<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMP0STER · SHOPPING CART</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0c0f;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(255, 70, 70, 0.08) 0%, transparent 25%),
        radial-gradient(circle at 80% 70%, rgba(255, 200, 50, 0.05) 0%, transparent 30%);
      font-family: 'Inter', sans-serif;
      color: #fff;
      line-height: 1.6;
    }
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 1.5rem 2rem; 
    }
    
    /* Header */
    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0 1.5rem;
      border-bottom: 1px solid rgba(255, 70, 70, 0.3);
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .glitch-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0.05em 0 0 rgba(255,0,0,0.7), -0.05em -0.025em 0 rgba(0,255,255,0.5);
      animation: glitch 4s infinite alternate;
    }
    @keyframes glitch {
      0% { text-shadow: 0.05em 0 0 rgba(255,0,0,0.5), -0.05em -0.025em 0 rgba(0,255,255,0.5); }
      100% { text-shadow: -0.05em 0.025em 0 rgba(255,0,0,0.6), 0.025em 0.05em 0 rgba(0,255,255,0.5); }
    }
    .ff-badge {
      background: #1e1e1e;
      padding: 0.2rem 0.9rem;
      border-radius: 30px;
      color: #ff5e5e;
      border: 1px solid #ff3838;
      font-size: 0.8rem;
      font-weight: 800;
      margin-left: 1rem;
    }
    .back-btn {
      color: #ffbe4d;
      text-decoration: none;
      padding: 0.5rem 1.5rem;
      border: 1px solid #ff6a4d;
      border-radius: 30px;
      transition: 0.2s;
    }
    .back-btn:hover {
      background: #ff6a4d;
      color: black;
    }
    
    /* Cart Layout */
    .cart-container {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
    }
    
    /* Cart Items */
    .cart-items {
      background: rgba(7, 10, 15, 0.9);
      border: 1px solid #ff3838;
      border-radius: 24px;
      padding: 1.5rem;
    }
    .cart-items h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ffbe4d;
      margin-bottom: 1.5rem;
    }
    .cart-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 100, 100, 0.2);
    }
    .cart-item:last-child {
      border-bottom: none;
    }
    .item-icon {
      font-size: 2rem;
      color: #ff984f;
    }
    .item-details h3 {
      color: #ffbe4d;
      margin-bottom: 0.3rem;
    }
    .item-price {
      color: #ffd966;
      font-weight: 700;
    }
    .item-quantity {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .qty-btn {
      background: #2a2e34;
      border: 1px solid #ff6a4d;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      transition: 0.2s;
    }
    .qty-btn:hover {
      background: #ff6a4d;
    }
    .qty-number {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ffbe4d;
    }
    .item-total {
      font-size: 1.2rem;
      font-weight: 700;
      color: #ffd966;
    }
    .remove-btn {
      background: #ff3838;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.2s;
    }
    .remove-btn:hover {
      background: #ff0000;
    }
    
    /* Cart Summary */
    .cart-summary {
      background: rgba(7, 10, 15, 0.9);
      border: 1px solid #ff8e4d;
      border-radius: 24px;
      padding: 1.5rem;
      position: sticky;
      top: 1.5rem;
    }
    .cart-summary h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ffbe4d;
      margin-bottom: 1.5rem;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .summary-total {
      display: flex;
      justify-content: space-between;
      margin: 1.5rem 0;
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffd966;
    }
    .discord-input {
      width: 100%;
      padding: 0.8rem;
      background: #2a2e34;
      border: 1px solid #ff6a4d;
      border-radius: 10px;
      color: white;
      margin: 0.5rem 0;
    }
    .checkout-btn {
      background: linear-gradient(145deg, #ff8e4d, #c5481f);
      border: none;
      padding: 1.2rem;
      font-size: 1.2rem;
      font-weight: 700;
      border-radius: 50px;
      color: white;
      width: 100%;
      cursor: pointer;
      margin-top: 1rem;
      transition: 0.2s;
    }
    .checkout-btn:hover {
      background: #ff6a2b;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(255, 142, 77, 0.4);
    }
    .clear-btn {
      background: transparent;
      border: 1px solid #ff3838;
      color: #ff3838;
      padding: 0.8rem;
      border-radius: 50px;
      width: 100%;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    /* Empty Cart */
    .empty-cart {
      text-align: center;
      padding: 3rem;
    }
    .empty-cart i {
      font-size: 4rem;
      color: #ff6a4d;
      margin-bottom: 1rem;
    }
    .shop-btn {
      display: inline-block;
      background: #ff6a4d;
      color: black;
      text-decoration: none;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-weight: 700;
      margin-top: 1.5rem;
    }
    
    /* Discord Banner */
    .discord-banner {
      background: #5865F2;
      border-radius: 16px;
      padding: 1rem;
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .discord-banner a {
      color: white;
      text-decoration: none;
      font-weight: 700;
    }
    
    /* Alert */
    .alert {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: none;
    }
    .alert-success { background: rgba(0, 255, 0, 0.2); border: 1px solid #00ff00; color: #00ff00; }
    .alert-error { background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; color: #ff0000; }
    
    @media (max-width: 1024px) {
      .cart-container { grid-template-columns: 1fr; }
      .cart-item { grid-template-columns: 1fr; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="top-header">
      <div style="display: flex; align-items: center;">
        <h1 class="glitch-title">IMP0STER</h1>
        <span class="ff-badge"><i class="fas fa-shopping-cart"></i> CART</span>
      </div>
      <div>
        <a href="/" class="back-btn"><i class="fas fa-store"></i> CONTINUE SHOPPING</a>
      </div>
    </header>

    <!-- Alert Message -->
    <div id="alertMessage" class="alert">
      <i class="fas fa-info-circle"></i> <span id="alertText"></span>
    </div>

    <!-- Cart Content -->
    <div id="cartContainer">
      <div style="text-align: center; padding: 3rem;">
        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #ffbe4d;"></i>
        <p style="margin-top: 1rem;">Loading cart...</p>
      </div>
    </div>
  </div>

  <script>
    let cartItems = [];
    let cartTotal = 0;

    document.addEventListener('DOMContentLoaded', function() {
      loadCart();
    });

    async function loadCart() {
      try {
        const response = await fetch('/api/cart');
        if (!response.ok) throw new Error('Failed to load cart');
        const data = await response.json();
        
        cartItems = data.items || [];
        cartTotal = data.total || 0;
        
        displayCart();
      } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to load cart', 'error');
      }
    }

    function displayCart() {
      const container = document.getElementById('cartContainer');
      
      if (cartItems.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <h2 style="color: #ffbe4d; margin-bottom: 1rem;">Your cart is empty</h2>
            <p style="color: #aaa; margin-bottom: 2rem;">Add some panels to get started!</p>
            <a href="/" class="shop-btn"><i class="fas fa-store"></i> BROWSE STORE</a>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="cart-container">
          <!-- Cart Items -->
          <div class="cart-items">
            <h2><i class="fas fa-box"></i> CART ITEMS (${cartItems.length})</h2>
            <div id="cartItemsList">
              ${cartItems.map(item => `
                <div class="cart-item" data-product-id="${item.product_id}">
                  <div class="item-icon"><i class="fas ${item.icon || 'fa-bolt'}"></i></div>
                  <div class="item-details">
                    <h3>${item.name}</h3>
                    <div class="item-price">$${item.price} ${item.price_suffix || ''}</div>
                  </div>
                  <div class="item-quantity">
                    <button class="qty-btn" onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
                    <span class="qty-number">${item.quantity}</span>
                    <button class="qty-btn" onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
                  </div>
                  <div class="item-total">$${(item.price * item.quantity).toFixed(2)}</div>
                  <button class="remove-btn" onclick="removeFromCart(${item.product_id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Cart Summary -->
          <div class="cart-summary">
            <h2><i class="fas fa-receipt"></i> ORDER SUMMARY</h2>
            <div class="summary-row">
              <span>Subtotal:</span>
              <span>$${cartTotal.toFixed(2)}</span>
            </div>
            <div class="summary-row">
              <span>Payment Method:</span>
              <span style="color: #5865F2;"><i class="fab fa-discord"></i> Discord</span>
            </div>
            <div class="summary-total">
              <span>TOTAL:</span>
              <span>$${cartTotal.toFixed(2)}</span>
            </div>
            
            <div style="margin-top: 1rem;">
              <label style="color: #ffbe4d;">Discord Contact (optional)</label>
              <input type="text" id="discordContact" class="discord-input" placeholder="Discord username#0000">
              <textarea id="orderNotes" class="discord-input" rows="2" placeholder="Additional notes..."></textarea>
            </div>
            
            <button class="checkout-btn" onclick="checkout()">
              <i class="fab fa-discord"></i> CHECKOUT WITH DISCORD
            </button>
            <button class="clear-btn" onclick="clearCart()">
              <i class="fas fa-trash"></i> CLEAR CART
            </button>
            
            <div class="discord-banner">
              <i class="fab fa-discord" style="font-size: 1.5rem;"></i>
              <div>
                <strong>Payment via Discord</strong><br>
                <small>Join our server after checkout</small>
              </div>
              <a href="https://discord.gg/EYT8NmaMph" target="_blank" style="margin-left: auto;">JOIN →</a>
            </div>
          </div>
        </div>
      `;
    }

    async function updateQuantity(productId, newQuantity) {
      if (newQuantity <= 0) {
        await removeFromCart(productId);
        return;
      }
      
      try {
        const response = await fetch('/api/cart/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: productId, quantity: newQuantity })
        });
        
        if (response.ok) {
          await loadCart();
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to update quantity', 'error');
      }
    }

    async function removeFromCart(productId) {
      try {
        const response = await fetch('/api/cart/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: productId })
        });
        
        if (response.ok) {
          await loadCart();
          showAlert('Item removed from cart', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to remove item', 'error');
      }
    }

    async function clearCart() {
      if (!confirm('Clear your entire cart?')) return;
      
      try {
        const response = await fetch('/api/cart/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          await loadCart();
          showAlert('Cart cleared', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Failed to clear cart', 'error');
      }
    }

    async function checkout() {
      if (cartItems.length === 0) {
        showAlert('Your cart is empty', 'error');
        return;
      }
      
      const discordContact = document.getElementById('discordContact')?.value || '';
      const notes = document.getElementById('orderNotes')?.value || '';
      
      try {
        const response = await fetch('/api/orders/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            discord_contact: discordContact,
            notes: notes
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert(data.message, 'success');
          
          // Show Discord payment modal
          setTimeout(() => {
            if (confirm('✅ Order created! Join Discord now to complete payment?')) {
              window.open(data.discord_link, '_blank');
              window.location.href = '/profile';
            }
          }, 1000);
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Checkout failed', 'error');
      }
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alertMessage');
      alert.className = `alert alert-${type}`;
      document.getElementById('alertText').textContent = message;
      alert.style.display = 'block';
      setTimeout(() => alert.style.display = 'none', 5000);
    }
  </script>
</body>
</html>
